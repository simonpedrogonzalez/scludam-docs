<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>scludam.stat_tests &mdash; scludam 0.2.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> scludam
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../readme.html">scludam (<strong>S</strong>tar <strong>CLU</strong>ster <strong>D</strong>etection <strong>A</strong>nd <strong>M</strong>embership estimation)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">scludam</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../diagrams.html">Diagrams</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">scludam</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>scludam.stat_tests</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for scludam.stat_tests</h1><div class="highlight"><pre>
<span></span><span class="c1"># scludam, Star CLUster Detection And Membership estimation package</span>
<span class="c1"># Copyright (C) 2022  Simón Pedro González</span>

<span class="c1"># This program is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>

<span class="c1"># This program is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU General Public License for more details.</span>

<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this program.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Module for useful statistical tests.</span>

<span class="sd">The tests in this module can be used to determine if there is cluster structure (the</span>
<span class="sd">data is &quot;clusterable&quot;) in a n dimensional numerical dataset.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="kn">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">RipleysKEstimator</span>
<span class="kn">from</span> <span class="nn">attrs</span> <span class="kn">import</span> <span class="n">define</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span> <span class="n">validators</span>
<span class="kn">from</span> <span class="nn">beartype</span> <span class="kn">import</span> <span class="n">beartype</span>
<span class="kn">from</span> <span class="nn">diptest</span> <span class="kn">import</span> <span class="n">diptest</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">beta</span><span class="p">,</span> <span class="n">ks_2samp</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">TransformerMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">BallTree</span><span class="p">,</span> <span class="n">DistanceMetric</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">MinMaxScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.utils</span> <span class="kn">import</span> <span class="n">resample</span>

<span class="kn">from</span> <span class="nn">scludam.type_utils</span> <span class="kn">import</span> <span class="n">Numeric1DArray</span><span class="p">,</span> <span class="n">Numeric2DArray</span>


<div class="viewcode-block" id="TestResult"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.TestResult">[docs]</a><span class="nd">@define</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">TestResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class to hold the results of a statistical test.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rejectH0 : bool</span>
<span class="sd">        Whether the null hypothesis was rejected.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">rejectH0</span><span class="p">:</span> <span class="nb">bool</span></div>


<div class="viewcode-block" id="StatTest"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.StatTest">[docs]</a><span class="k">class</span> <span class="nc">StatTest</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base class for statistical tests.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="StatTest.test"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.StatTest.test">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TestResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Perform the test.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : Numeric2DArray</span>
<span class="sd">            numpy numeric 2d array with the data to be tested.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TestResult</span>
<span class="sd">            Test result. Its fields depend on the specific test.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="HopkinsTestResult"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.HopkinsTestResult">[docs]</a><span class="nd">@define</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HopkinsTestResult</span><span class="p">(</span><span class="n">TestResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Results of a Hopkins test.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rejectH0: bool</span>
<span class="sd">        True if the null hypothesis is rejected.</span>
<span class="sd">    pvalue: Number</span>
<span class="sd">        The p-value of the test.</span>
<span class="sd">    value: Number</span>
<span class="sd">        The value of the Hopkins statistic.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span><span class="p">:</span> <span class="n">Number</span>
    <span class="n">pvalue</span><span class="p">:</span> <span class="n">Number</span></div>


<div class="viewcode-block" id="HopkinsTest"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.HopkinsTest">[docs]</a><span class="nd">@define</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">HopkinsTest</span><span class="p">(</span><span class="n">StatTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to perform a Hopkins spatial randomness test.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    n_iters : int, optional</span>
<span class="sd">        Number of iterations to perform the test. Final Hopkins statistic result</span>
<span class="sd">        is taken as the median of the results, by default is 100.</span>
<span class="sd">    n_samples : int, optional</span>
<span class="sd">        Number of samples to take from the data, by default is ``0.1*n`` where n is</span>
<span class="sd">        the number of points in the data set, as it is the recommended value.</span>
<span class="sd">    metric : Union[str, DistanceMetric], optional</span>
<span class="sd">        Metric to use for the distance between points, by default is &#39;euclidean&#39;.</span>
<span class="sd">        Can be str or sklearn.neighbors.DistanceMetric.</span>
<span class="sd">    threshold : Number, optional</span>
<span class="sd">        Threshold to use with the Hopkins statistic value to define if H0 is rejected,</span>
<span class="sd">        by default is None. If set, it is used instead of the pvalue_threshold.</span>
<span class="sd">    pvalue_threshold : float, optional</span>
<span class="sd">        Threshold to use with the p-value to define if H0 is rejected, by default</span>
<span class="sd">        is 0.05.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The test compares the distance between a sample of ``m`` points ``X&#39;``</span>
<span class="sd">    from the data set ``X`` and their nearest neighbors in ``X``, to the</span>
<span class="sd">    distances from ``X`` to their nearest neighbors in a uniform distribution.</span>
<span class="sd">    The null hypothesis is:</span>

<span class="sd">    *  H0: The dataset X comes from a Poisson Point Process.</span>

<span class="sd">    Which can be thought of as:</span>

<span class="sd">    *  H0: The dataset X does not present cluster structure.</span>

<span class="sd">    The formula to calculate the Hopkins statistic [1]_</span>
<span class="sd">    is ``h = sum(d1**l) / (sum(d1**l) + sum(d2**l))``, where:</span>

<span class="sd">    *  d1: distance_to_nearest_neighbor_in_X</span>
<span class="sd">    *  d2: distance_to_nearest_neighbor_in_uniform_distribution</span>
<span class="sd">    *  l: dimensionality of the data</span>

<span class="sd">    The Hopkins statistic is a number between 0.5 and 1. A value ``~0.5`` supports</span>
<span class="sd">    the null hypothesis. A value ``~1.0`` supports the alternative hypothesis.</span>
<span class="sd">    To get the p-value, the statistic is compared to a beta distribution with</span>
<span class="sd">    parameters ``(m, m)``.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [1] Hopkins, B. and Skellam, J.G. (1954). A new method of determining the type of</span>
<span class="sd">         distribution of plant individuals”. Annals of Botany, 1954, 18(2),</span>
<span class="sd">         pp.213-227. https://doi.org/10.1093/oxfordjournals.aob.a083391</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. literalinclude:: ../../examples/stat_tests/hopkins.py</span>
<span class="sd">        :language: python</span>
<span class="sd">        :linenos:</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metric</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">DistanceMetric</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;euclidean&quot;</span>
    <span class="n">n_iters</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="c1"># interpretation:</span>
    <span class="c1"># H0: data comes from uniform distribution</span>
    <span class="c1"># H1: data does not come from uniform distribution</span>
    <span class="c1"># if h = u/(u+w) ~ 1 =&gt; w = 0 luego hay estructura</span>
    <span class="c1"># if h = u/(u+w) ~ .5 =&gt; w ~ u luego no hay estructura</span>
    <span class="c1"># if h &gt; .75 =&gt; reject H0, and in general  indicates a clustering</span>
    <span class="c1"># tendency at the 90% confidence level.</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Number</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">pvalue_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>

    <span class="k">def</span> <span class="nf">_get_pvalue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">beta</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">value</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<div class="viewcode-block" id="HopkinsTest.test"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.HopkinsTest.test">[docs]</a>    <span class="nd">@beartype</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform the Hopkins test.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : Numeric2DArray</span>
<span class="sd">            Array containing the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        HopkinsTestResult</span>
<span class="sd">            Test results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">obs</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_iters</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">==</span> <span class="s2">&quot;mahalanobis&quot;</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;V&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">BallTree</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">leaf_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">dist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">sample_nn_distance</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">max_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">min_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">uniform_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                <span class="n">low</span><span class="o">=</span><span class="n">min_data</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">max_data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">dims</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">dist</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">uniform_sample</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">uniform_nn_distance</span> <span class="o">=</span> <span class="n">dist</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">sample_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_nn_distance</span><span class="o">**</span><span class="n">dims</span><span class="p">)</span>
            <span class="n">uniform_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">uniform_nn_distance</span><span class="o">**</span><span class="n">dims</span><span class="p">)</span>

            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">uniform_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">uniform_sum</span> <span class="o">+</span> <span class="n">sample_sum</span><span class="p">))</span>

        <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">))</span>
        <span class="n">pvalue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_pvalue</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rejectH0</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rejectH0</span> <span class="o">=</span> <span class="n">pvalue</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_threshold</span>
        <span class="k">return</span> <span class="n">HopkinsTestResult</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">rejectH0</span><span class="o">=</span><span class="n">rejectH0</span><span class="p">,</span> <span class="n">pvalue</span><span class="o">=</span><span class="n">pvalue</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DipDistTestResult"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.DipDistTestResult">[docs]</a><span class="nd">@define</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DipDistTestResult</span><span class="p">(</span><span class="n">TestResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Results of a dip dist test.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    value : Number</span>
<span class="sd">        The value of the dip statistic.</span>
<span class="sd">    pvalue : Number</span>
<span class="sd">        The pvalue of the test.</span>
<span class="sd">    dist : Numeric1DArray</span>
<span class="sd">        The ordered distance array.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span><span class="p">:</span> <span class="n">Number</span>
    <span class="n">pvalue</span><span class="p">:</span> <span class="n">Number</span>
    <span class="n">dist</span><span class="p">:</span> <span class="n">Numeric1DArray</span></div>


<div class="viewcode-block" id="DipDistTest"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.DipDistTest">[docs]</a><span class="nd">@define</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">DipDistTest</span><span class="p">(</span><span class="n">StatTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to perform a Dip-Dist test of multimodality over pairwise distances.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    n_samples : int, optional</span>
<span class="sd">        number of samples to take from the data, by default is set to the number</span>
<span class="sd">        of points in the data set. If n_samples is provided, then it is set to</span>
<span class="sd">        min(n, n_samples).</span>
<span class="sd">    metric : Union[str, DistanceMetric], optional</span>
<span class="sd">        Metric to use for the distance between points, by default is &#39;euclidean&#39;. Can be</span>
<span class="sd">        str or sklearn.neighbors.DistanceMetric.</span>
<span class="sd">    pvalue_threshold : float, optional</span>
<span class="sd">        Threshold to use with the p-value to define if H0 is rejected, by default</span>
<span class="sd">        is ``0.05``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The test analyzes the pairwise distance distribution [2]_ between points</span>
<span class="sd">    in a data set to determine if said distribution is multimodal.</span>
<span class="sd">    The null hypothesis is:</span>

<span class="sd">    *  H0: The distance distribution is unimodal.</span>

<span class="sd">    Which can be thought of as:</span>

<span class="sd">    *  H0: The data set X does not present cluster structure.</span>

<span class="sd">    Hartigan&#39;s Dip statistic [3]_ is the maximum difference between an</span>
<span class="sd">    empirical distribution and its closest unimodal distribution</span>
<span class="sd">    calculated using the greatest convex minorant</span>
<span class="sd">    and the least concave majorant of the bounded distribution function.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [2] A. Adolfsson, M. Ackerman, N. C. Brownstein (2018). To Cluster,</span>
<span class="sd">         or Not to Cluster: An Analysis of Clusterability Methods</span>
<span class="sd">         . https://doi.org/10.48550/arXiv.1808.08317</span>
<span class="sd">    .. [3] J. A. Hartigan and P. M. Hartigan (1985). The Dip Test of Unimodality.</span>
<span class="sd">         Annals of Statistics 13, 70–84. DOI: 10.1214/aos/1176346577</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. literalinclude:: ../../examples/stat_tests/dipdist.py</span>
<span class="sd">        :language: python</span>
<span class="sd">        :linenos:</span>
<span class="sd">    .. image:: ../../examples/stat_tests/dipdist.png</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">n_samples</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metric</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;euclidean&quot;</span>
    <span class="n">pvalue_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span>

<div class="viewcode-block" id="DipDistTest.test"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.DipDistTest.test">[docs]</a>    <span class="nd">@beartype</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform the Dip-Dist test.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : Numeric2DArray</span>
<span class="sd">            numpy 2d numeric array containing the data.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DipDistTestResult</span>
<span class="sd">            The test results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obs</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">n_samples</span> <span class="o">=</span> <span class="n">obs</span>

        <span class="n">sample</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">tril</span><span class="p">(</span><span class="n">pairwise_distances</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)))</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">msort</span><span class="p">(</span><span class="n">dist</span><span class="p">[</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">dip</span><span class="p">,</span> <span class="n">pval</span> <span class="o">=</span> <span class="n">diptest</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">rejectH0</span> <span class="o">=</span> <span class="n">pval</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_threshold</span>
        <span class="k">return</span> <span class="n">DipDistTestResult</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">dip</span><span class="p">,</span> <span class="n">pvalue</span><span class="o">=</span><span class="n">pval</span><span class="p">,</span> <span class="n">rejectH0</span><span class="o">=</span><span class="n">rejectH0</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RipleyKTestResult"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.RipleyKTestResult">[docs]</a><span class="nd">@define</span><span class="p">(</span><span class="n">auto_attribs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RipleyKTestResult</span><span class="p">(</span><span class="n">TestResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Results of a Ripley&#39;s K test.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rejectH0: bool</span>
<span class="sd">        True if the null hypothesis is rejected.</span>
<span class="sd">    value: Number</span>
<span class="sd">        The value calculated to determine if H0 is rejected. If</span>
<span class="sd">        the test ``mode`` is ``chiu`` or ``ripley``, then the value is the</span>
<span class="sd">        the ``supremum`` statistic. If the test mode is ``ks``, then</span>
<span class="sd">        the value is the pvalue of the Kolmogorov-Smirnov test.</span>
<span class="sd">    radii: Numeric1DArray</span>
<span class="sd">        The radii used in the test.</span>
<span class="sd">    l_function: Numeric1DArray</span>
<span class="sd">        The L function values.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span><span class="p">:</span> <span class="n">Number</span>
    <span class="n">radii</span><span class="p">:</span> <span class="n">Numeric1DArray</span>
    <span class="n">l_function</span><span class="p">:</span> <span class="n">Numeric1DArray</span></div>


<div class="viewcode-block" id="RipleysKTest"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.RipleysKTest">[docs]</a><span class="nd">@define</span>
<span class="k">class</span> <span class="nc">RipleysKTest</span><span class="p">(</span><span class="n">StatTest</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to perform the Ripleys K test of 2D spatial randomness.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    rk_estimator : astropy.stats.RipleysKEstimator, optional</span>
<span class="sd">        Estimator to use for the Ripleys K function [4]_, by default</span>
<span class="sd">        is None. Only used if</span>
<span class="sd">        a custom RipleysKEstimator configuration is needed.</span>

<span class="sd">    mode : str, optional</span>
<span class="sd">        The comparison method to use to determine the rejection of H0, by default is</span>
<span class="sd">        &quot;ripley&quot;. Allowed values are:</span>

<span class="sd">        #. &quot;ripley&quot;: H0 rejected if ``s &gt; ripley_factor * sqrt(area) / n`` where</span>

<span class="sd">            *   area: is the area of the 2D data set taken as a square window.</span>
<span class="sd">            *   n: is the number of points in the data set.</span>
<span class="sd">            *   ripley_factor: are the tabulated values calculated by Ripleys [4]_</span>
<span class="sd">                to determine p-value significance. Available Ripleys factors</span>
<span class="sd">                are ``p-value = 0.05`` -&gt; ``factor = 1.42`` and</span>
<span class="sd">                ``p-value = 0.01`` -&gt; ``factor = 1.68``.</span>

<span class="sd">        #. &quot;chiu&quot;: H0 rejected if ``s &gt; chiu_factor * sqrt(area) / n`` where:</span>

<span class="sd">            *   chiu_factor: are the tabulated values suggested by Chiu [5]_ to</span>
<span class="sd">                determine p-value significance. Available Chiu factors are</span>
<span class="sd">                ``p-value = 0.1 -&gt; factor = 1.31``,</span>
<span class="sd">                ``p-value = 0.05 -&gt; factor = 1.45`` and</span>
<span class="sd">                ``p-value = 0.01 -&gt; factor = 1.75``.</span>

<span class="sd">        #. &quot;ks&quot;: H0 rejected if</span>
<span class="sd">           ``kolmogorov_smirnov_test_pvalue &lt; pvalue_threshold``, where</span>
<span class="sd">           kolmogorov_smirnov_test_pvalue is the p-value of the Kolmogorov Smirnov test</span>
<span class="sd">           comparing the estimated L function to the theoretical L function of a uniform</span>
<span class="sd">           distribution. This option is experimental and should be used with caution.</span>

<span class="sd">    radii : Numeric1DArray, optional</span>
<span class="sd">        numpy 1d numeric array containing the radii to use for the Ripleys K function,</span>
<span class="sd">        by default is None. If radii is None, radii are taken in a range</span>
<span class="sd">        ``[0, max_radius]``,</span>
<span class="sd">        where max_radius is calculated as:</span>

<span class="sd">            *  ``recommended_radius = short_side_of_rectangular_window / 4``</span>
<span class="sd">            *  ``recommended_radius_for_large_data_sets = sqrt(100 / pi * n)``</span>
<span class="sd">            *  ``max_radius = min(recommended_radius, recommended_radius_for_large_data_sets)``</span>

<span class="sd">        The steps between the radii values are calculated as</span>
<span class="sd">        ``step = max_radius / 128 / 4``.</span>
<span class="sd">        This procedure is the recommended one in R spatstat package [6]_.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If tabulated factor for the chosen p-value threshold is not available, or if the</span>
<span class="sd">        chosen p-value threshold is invalid.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The test calculates the value of an estimate for the L function [7]_ (a</span>
<span class="sd">    form of Ripleys K function) for a set of radii taken from the</span>
<span class="sd">    center of the data set, and compares it to the theoretical L</span>
<span class="sd">    function of a uniform distribution. The null hypothesis is:</span>

<span class="sd">    *  H0: The data set X comes from a Poisson Point Process.</span>

<span class="sd">    Which can be thought of as:</span>

<span class="sd">    *  H0: The data set X does not present cluster structure.</span>

<span class="sd">    The Ripleys K(r) function is defined as the expected number</span>
<span class="sd">    of additional random points within a distance r of a typical random point.</span>
<span class="sd">    For a completely random point process (Poisson Point Process),</span>
<span class="sd">    ``K(r) = pi*r^2``. The L(r) function is a form of K(r) defined as</span>
<span class="sd">    ``L(r) = sqrt(K(r)/pi)``.</span>
<span class="sd">    The statistic to define if H0 is rejected based on the L function is the</span>
<span class="sd">    ``supremum`` of the difference ``s = max(L(r) - r)``.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    .. [4] B. D. Ripley (1979). Tests of Randomness for Spatial Point Patterns.</span>
<span class="sd">         J. R. Statist. Soc. B (1979), 41, No.3, pp. 368-374.</span>
<span class="sd">         https://doi.org/10.1111/j.2517-6161.1979.tb01091.x</span>
<span class="sd">    .. [5] S. N. Chiu (2007). Correction to Koen&#39;s critical values in testing</span>
<span class="sd">         spatial randomness. Journal of Statistical Computation and Simulation</span>
<span class="sd">         2007 77(11-12):1001-1004. DOI: 10.1080/10629360600989147</span>
<span class="sd">    .. [6] A. Baddeley, R. Turner (2005). Spatstat: An R Package for Analyzing</span>
<span class="sd">         Spatial Point Patterns. Journal of Statistical Software, 12(6), 1–42.</span>
<span class="sd">         DOI: 10.18637/jss.v012.i06.</span>
<span class="sd">    .. [7] J. Besag (1977). Contribution to the Discussion on Dr. Ripley’s</span>
<span class="sd">         Paper. Journals of the Royal Statistical Society, B39, 193-195.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. literalinclude:: ../../examples/stat_tests/ripley.py</span>
<span class="sd">        :language: python</span>
<span class="sd">        :linenos:</span>
<span class="sd">    .. image:: ../../examples/stat_tests/ripley.png</span>

<span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>

    <span class="n">rk_estimator</span><span class="p">:</span> <span class="n">RipleysKEstimator</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">_scaler</span><span class="p">:</span> <span class="n">TransformerMixin</span> <span class="o">=</span> <span class="n">MinMaxScaler</span><span class="p">()</span>

    <span class="n">_ripley_factors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mf">0.05</span><span class="p">:</span> <span class="mf">1.42</span><span class="p">,</span>
        <span class="mf">0.01</span><span class="p">:</span> <span class="mf">1.68</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">_chiu_factors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="mf">0.1</span><span class="p">:</span> <span class="mf">1.31</span><span class="p">,</span>
        <span class="mf">0.05</span><span class="p">:</span> <span class="mf">1.45</span><span class="p">,</span>
        <span class="mf">0.01</span><span class="p">:</span> <span class="mf">1.75</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">validator</span><span class="o">=</span><span class="n">validators</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s2">&quot;ripley&quot;</span><span class="p">,</span> <span class="s2">&quot;chiu&quot;</span><span class="p">,</span> <span class="s2">&quot;ks&quot;</span><span class="p">]),</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;ripley&quot;</span>
    <span class="p">)</span>

    <span class="n">radii</span><span class="p">:</span> <span class="n">Numeric1DArray</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">pvalue_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>

    <span class="nd">@pvalue_threshold</span><span class="o">.</span><span class="n">validator</span>
    <span class="k">def</span> <span class="nf">_check_pvalue_threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ripley&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ripley_factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a valid pvalue threshold for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> rule.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_ripley_factors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;chiu&quot;</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chiu_factors</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a valid pvalue threshold for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mode</span><span class="si">}</span><span class="s2"> rule.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_chiu_factors</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a valid pvalue threshold. Must be between 0 and 1.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_empirical_csr_rule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">l_function</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="n">radii</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="n">area</span><span class="p">:</span> <span class="n">Number</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="n">supremum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l_function</span> <span class="o">-</span> <span class="n">radii</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ripley&quot;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ripley_factors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pvalue_threshold</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chiu_factors</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pvalue_threshold</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">supremum</span><span class="p">,</span> <span class="n">supremum</span> <span class="o">&gt;=</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">area</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_ks_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">l_function</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="n">radii</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">):</span>
        <span class="n">pvalue</span> <span class="o">=</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">l_function</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span><span class="o">.</span><span class="n">pvalue</span>
        <span class="k">return</span> <span class="n">pvalue</span><span class="p">,</span> <span class="n">pvalue</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvalue_threshold</span>

<div class="viewcode-block" id="RipleysKTest.test"><a class="viewcode-back" href="../../scludam.stat_tests.html#scludam.stat_tests.RipleysKTest.test">[docs]</a>    <span class="nd">@beartype</span>
    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Numeric2DArray</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Perform the Ripleys K test of 2D spatial randomness.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : Numeric2DArray</span>
<span class="sd">            numpy 2d numeric array containing the data set to test.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RipleysKTestResult</span>
<span class="sd">            Result of the Ripleys K test.</span>


<span class="sd">        Warns</span>
<span class="sd">        -----</span>
<span class="sd">        UserWarning</span>
<span class="sd">            Warns if some dataset points are repeated (exactly equal). In that case,</span>
<span class="sd">            the RipleysKEstimator will not be able to calculate the L function,</span>
<span class="sd">            so repeated points will will be eliminated before the test. Bound to</span>
<span class="sd">            change when RipleysKEstimator implementation is changed.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">data_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data_unique</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;There are repeated data points that cause&quot;</span>
                <span class="s2">&quot; astropy.stats.RipleysKEstimator to break, they will be removed.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data_unique</span>

        <span class="n">obs</span><span class="p">,</span> <span class="n">dims</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># negative data values are not handled properly by RipleysKEstimator</span>
        <span class="c1"># hence, it seems that MinMax scaling is a must</span>
        <span class="c1"># in the future, an alternative RipleysKEstimator implementation could be used</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">x_min</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">x_max</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">y_min</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># considers rectangular window</span>
            <span class="c1"># based on R spatstat rmax.rule</span>
            <span class="n">short_side</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span>
            <span class="n">radii_max_ripley</span> <span class="o">=</span> <span class="n">short_side</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">radii_max_large</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">obs</span><span class="p">))</span>
            <span class="n">radii_max</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radii_max_ripley</span><span class="p">,</span> <span class="n">radii_max_large</span><span class="p">)</span>
            <span class="n">step</span> <span class="o">=</span> <span class="n">radii_max</span> <span class="o">/</span> <span class="mi">128</span> <span class="o">/</span> <span class="mi">4</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">radii_max</span> <span class="o">+</span> <span class="n">step</span><span class="p">,</span> <span class="n">step</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rk_estimator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Could be extended to other shapes</span>
            <span class="c1"># depending on the edge correction methods</span>
            <span class="c1"># available. Could use ConvexHull to get the</span>
            <span class="c1"># area.</span>
            <span class="n">area</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_max</span> <span class="o">-</span> <span class="n">x_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_max</span> <span class="o">-</span> <span class="n">y_min</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rk_estimator</span> <span class="o">=</span> <span class="n">RipleysKEstimator</span><span class="p">(</span>
                <span class="n">area</span><span class="o">=</span><span class="n">area</span><span class="p">,</span>
                <span class="n">x_min</span><span class="o">=</span><span class="n">x_min</span><span class="p">,</span>
                <span class="n">x_max</span><span class="o">=</span><span class="n">x_max</span><span class="p">,</span>
                <span class="n">y_min</span><span class="o">=</span><span class="n">y_min</span><span class="p">,</span>
                <span class="n">y_max</span><span class="o">=</span><span class="n">y_max</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rk_estimator</span><span class="o">.</span><span class="n">area</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;mode&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Best mode for rectangular window</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ripley&quot;</span>

        <span class="n">l_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rk_estimator</span><span class="o">.</span><span class="n">Lfunction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;ks&quot;</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">rejectH0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ks_rule</span><span class="p">(</span><span class="n">l_function</span><span class="p">,</span> <span class="n">radii</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">rejectH0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_empirical_csr_rule</span><span class="p">(</span><span class="n">l_function</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">area</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">RipleyKTestResult</span><span class="p">(</span>
            <span class="n">value</span><span class="o">=</span><span class="n">value</span><span class="p">,</span> <span class="n">rejectH0</span><span class="o">=</span><span class="n">rejectH0</span><span class="p">,</span> <span class="n">radii</span><span class="o">=</span><span class="n">radii</span><span class="p">,</span> <span class="n">l_function</span><span class="o">=</span><span class="n">l_function</span>
        <span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Simón Pedro González.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>